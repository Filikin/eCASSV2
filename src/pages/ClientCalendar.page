<apex:page standardcontroller="Contact" extensions="CalendarController" action="{!pageLoad}">

    <link href="{!$Resource.fullCalendarCSS}" rel="stylesheet" />
    <link href="{!$Resource.fullCalendarPrintCSS}" rel="stylesheet" media="print" />
    <script src="{!$Resource.jQuery}"></script>
    <script src="{!$Resource.jQueryUI}"></script>
    <script src="{!$Resource.moment}"></script>
    <script src="{!$Resource.fullCalendarMinJS}"></script>
    <script>
        function PrintPopup(data)
        {
            var mywindow = window.open('', '{!$Label.Client_Calendar_Title}', 'height=400,width=1200,menubar=yes');
            mywindow.document.write('<html><head><title>{!$Label.Client_Calendar_Title}</title>');
            mywindow.document.write('<link href="{!$Resource.fullCalendarCSS}" rel="stylesheet" />');
            mywindow.document.write('<link href="{!$Resource.fullCalendarPrintCSS}" rel="stylesheet" media="print" />');
            mywindow.document.write('</head><body >');
            mywindow.document.write(data);
            mywindow.document.write('</body></html>');

            mywindow.document.close(); // necessary for IE >= 10
            mywindow.focus(); // necessary for IE >= 10

  //          mywindow.print();
 //           mywindow.close();

            return true;
        }

 //We need to wrap everything in a doc.ready function so that the code fires after the DOM is loaded
 $(document).ready(function() {
  //Call the fullCallendar method. You can replace the '#calendar' with the ID of the dom element where you want the calendar to go.
  $('#calendar').fullCalendar({
        customButtons: {
        printButton: {
            text: '{!$Label.Print}',
            click: function()
            {
                PrintPopup ($('#clientCalendar').html());
            }
        }
    },
   header: {
    left: 'prev,next today printButton',
    center: 'title',
    right: 'month,agendaWeek,agendaDay'
   },
   height: "auto",
   editable: true,
   businessHours: true,
   minTime: " {!$Setup.eCASS_settings__c.Client_Calendar_Start_Time__c }",
   maxTime: " {!$Setup.eCASS_settings__c.Client_Calendar_End_Time__c }",
   eventDrop: function(event, delta, revertFunc)
   {
        if (!confirm({!$Label.Client_Calendar_Moving_Warning}))
        {
            revertFunc();
        }
        else
        {
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.CalendarController.attendanceMoved}',
                event.id, event.start.format('YYYY-MM-DD HH:mm:ss'), event.end.format('YYYY-MM-DD HH:mm:ss'),
                function(result, event)
                {
                },
                {escape: true}
            );
        }
    },
    eventResize: function(event, delta, revertFunc)
    {
        if (!confirm({!$Label.Client_Calendar_Duration_Change_Warning}))
        {
            revertFunc();
        }
        else
        {
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.CalendarController.attendanceDurationChanged}',
                event.id, delta.asMinutes(), event.end.format('YYYY-MM-DD HH:mm:ss'),
                function(result, event)
                {
                },
                {escape: true}
            );
        }
   },
   events:
   [
    // At run time, this APEX Repeat will render the array elements for the events array
    <apex:repeat value="{!events}" var="e">
     {
      title: "{!e.title}",
      start: '{!e.startString}',
      end: '{!e.endString}',
      url: '{!e.url}',
      allDay: {!e.allDay},
      className: '{!e.className}',
      id: '{!e.id}',
      editable: {!e.editable}
     },
    </apex:repeat>
   ],
   timeFormat: 'H:mm',
    slotLabelFormat: 'H:mm'
  });

 });

    </script>
    <div id="clientCalendar">
        <style>
            #cal-options {
                float: left;
            }

            #cal-legend {
                float: right;
            }

                #cal-legend ul {
                    margin: 0;
                    padding: 0;
                    list-style: none;
                }

                    #cal-legend ul li {
                        margin: 0;
                        padding: 5px;
                        float: left;
                    }

                        #cal-legend ul li span {
                            display: block;
                            height: 16px;
                            width: 16px;
                            margin-right: 4px;
                            float: left;
                            border-radius: 4px;
                        }

            #calendar {
                margin-top: 20px;
            }

                #calendar a:hover {
                    color: #fff !important;
                }

            .fc-event-inner {
                padding: 3px;
            }

            .Course_Attendance {
                background: #56458c;
                border-color: #56458c;
            }

            .Drop_In_Attendance {
                background: #cc9933;
                border-color: #cc9933;
            }

            .One_to_One_Attendance {
                background: #1797c0;
                border-color: #1797c0;
            }

            .Open_Access_Attendance {
                background: #ff6a00;
                border-color: #ff6a00;
            }
        </style>
        <apex:sectionheader title="{!$Label.Client_Calendar_Header} {!client.Full_name__c}" />
        <apex:outputpanel id="calPanel">
            <apex:form >
                <div id="cal-legend">
                    <ul>
                        <li><span class="Course_Attendance"></span>{!$Label.Course_Attendance_Record_Type}</li>
                        <li><span class="Drop_In_Attendance"></span>{!$Label.Drop_In_Attendance_Record_Type}</li>
                        <li><span class="One_to_One_Attendance"></span>{!$Label.One_to_One_Attendance_Record_Type}</li>
                        <li><span class="Open_Access_Attendance"></span>{!$Label.Open_Access_Attendance_Record_Type}</li>
                    </ul>
                    <div style="clear:both;"> <!--fix floats--> </div>
                </div>
                <div style="clear:both;"><!--fix floats--> </div>
                <div id="calendar"></div>
            </apex:form>
        </apex:outputpanel>
    </div>
</apex:page>